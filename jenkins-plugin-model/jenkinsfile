pipeline {
    agent any

    environment {
        DOTNET_ROOT = "${env.HOME}/.dotnet"
        PATH = "${env.HOME}/.dotnet:${env.HOME}/.dotnet/tools:${env.PATH}"
    }

    stages {

        stage('Verify Shell Environment') {
            steps {
                echo "Job Name: ${env.JOB_NAME}"
                echo "Build Number: ${env.BUILD_NUMBER}"
                
                // Docker version
                sh 'docker --version'

                // .NET version
                sh 'dotnet --info'
            }
        }

        stage('Checkout Jenkins Upgrade3 Git Repository') {
            steps {
                script {
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: '*/master']],
                        userRemoteConfigs: [[url: 'https://github.com/Ezioraz/Jenkins_Upgradev3.git']],
                        extensions: [
                            [$class: 'CleanBeforeCheckout'],
                            [$class: 'CloneOption', noTags: false, shallow: true, depth: 1]
                        ]
                    ])
                }
            }
        }

        stage('Build Application') {
            steps {
                sh 'chmod +x ./jenkins-plugin-model/ci/01-build.sh && ./jenkins-plugin-model/ci/01-build.sh'
            }
        }

        stage('Unit Test') {
            steps {
                sh 'chmod +x ./jenkins-plugin-model/ci/03-unit-test.sh && ./jenkins-plugin-model/ci/03-unit-test.sh'
                
                // MSTest step (ensure the plugin and agent tools are configured)
                mstest testResultsFile: "**/*.trx"
            }
        }

        stage('Push Docker Image') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: '45cf2a67-c654-4425-a8c2-c1f65a4cb664', 
                    usernameVariable: 'DOCKER_HUB_USER', 
                    passwordVariable: 'DOCKER_HUB_PASSWORD'
                )]) {
                    sh 'chmod +x ./jenkins-plugin-model/ci/04-push.sh'
                    sh "./jenkins-plugin-model/ci/04-push.sh ${env.BUILD_NUMBER}"
                }
                echo "Build Completed - Job Name: ${env.JOB_NAME}  --  Build Number: ${env.BUILD_NUMBER}"
            }
        }
    }
}
